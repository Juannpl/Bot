name: CI/CD Bot Apex

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1️⃣ Checkout code
      - name: Checkout latest code
        uses: actions/checkout@v4

      # 2️⃣ Build Docker image avec les variables d'environnement depuis les secrets
      - name: Build Docker image
        run: |
          docker build \
            --build-arg GUILD_ID=${{ secrets.GUILD_ID }} \
            --build-arg DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }} \
            --build-arg APEX_API_KEY=${{ secrets.APEX_API_KEY }} \
            -t bot_apex:latest .

      # 3️⃣ Stop et supprimer l'ancien container s'il existe
      - name: Stop previous container
        run: |
          docker stop bot_apex || true
          docker rm bot_apex || true

      # 4️⃣ Run le nouveau container
      - name: Run new container
        run: |
          docker run -d --name bot_apex \
            -e GUILD_ID=${{ secrets.GUILD_ID }} \
            -e DISCORD_TOKEN=${{ secrets.DISCORD_TOKEN }} \
            -e APEX_API_KEY=${{ secrets.APEX_API_KEY }} \
            bot_apex:latest

      # 5️⃣ Fin
      - name: Finished
        run: echo "Deployment and bot execution completed."
